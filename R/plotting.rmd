Random Plots for visualisation during the coding process

```{r, libraries}
# used packages
library(ggplot2)
library(ggpubr)
library(rnaturalearth)
library(sf)
library(sp)
library(terra)
library(ncdf4)
library(dplyr)
```

```{r, bboxes}
## plot cleaned occurence data with native extent and extent of interest
sf_use_s2(FALSE) # to get rectangular intersect boxes instead of a projection

occs_global <- readRDS("F:/BscBio_LP23_data/occurence/axyridis_clean.rds")
occs_global_sf <- st_as_sf(occs_global, coords = c(
    "decimalLongitude",
    "decimalLatitude"
), crs = 4326)
countries <- ne_countries(scale = "medium", returnclass = "sf")
countries <- st_transform(countries, crs = 4326)

# create boundary boxes for europe and asia (native range)
# extent of europe
eu_box <- c(xmin = -25, ymin = 35, xmax = 65, ymax = 72)
class(eu_box) <- "bbox"
eu_box <- st_as_sfc(eu_box)
eu_box <- st_as_sf(eu_box, crs = 4326)
in_eu <- st_intersects(eu_box, occs_global_sf, sparse = FALSE)
occs_eu <- occs_global[as.vector(in_eu), ]

# extent of native range (Orlova-Bienkowskaja, Ukrainsky & Brown, 2015)
as_box <- c(xmin = 70, ymin = 20, xmax = 150, ymax = 65)
class(as_box) <- "bbox"
as_box <- st_as_sfc(as_box)
as_box <- st_as_sf(as_box, crs = 4326)
in_as <- st_intersects(as_box, occs_global_sf, sparse = FALSE)
occs_as <- occs_global[as.vector(in_as), ]
```

```{r}
# plot points in extents
map <- ggplot(countries) +
    geom_sf(data = countries, colour = "black", fill = "white") +
    xlim(-25, 65) +
    ylim(35, 72) +
    geom_point(
        data = occs_global, aes(x = decimalLongitude, y = decimalLatitude),
        colour = "cyan", alpha = 0.8
    ) +
    geom_point(
        data = occs_eu, aes(x = decimalLongitude, y = decimalLatitude),
        colour = "blue", alpha = 0.8
    )
map
```

```{r}
# plot points in extents
map <- ggplot(countries) +
    geom_sf(data = countries, colour = "black", fill = "white") +
    xlim(70, 150) +
    ylim(20, 65) +
    geom_point(
        data = occs_global, aes(x = decimalLongitude, y = decimalLatitude),
        colour = "cyan", alpha = 0.8
    ) +
    geom_point(
        data = occs_as, aes(x = decimalLongitude, y = decimalLatitude),
        colour = "blue", alpha = 0.8
    )
plot(map)
```

```{r}
max(occs_global$coordinateUncertaintyInMeters)
hist(occs_global$coordinateUncertaintyInMeters)
hist(occs_global$year)
```

```{r, plot lc val test}
lc_16 <- rast("data/cropped_rasters/Cop_LC_2016_eu.grd")
lc_16_v <- lc_16 == 200
plot(lc_16_v)
```

```{r, plot glob raw vs clean gbif}
# load raw gbif raster
axyridis_raw <- read.csv("R/data/occurence_data/Harmonia-axyridis_gbif_raw.csv",
    header = TRUE,
    sep = "\t"
)
axyridis_clean <- readRDS("R/data/occurence_data/axyridis_clean.rds")

## plot global on countries map
countries <- ne_countries(scale = "medium", returnclass = "sf")
countries <- st_transform(countries, crs = 4326)
m_glob <- ggplot(countries) +
    geom_sf(data = countries, colour = "black", fill = "white") +
    geom_point(
        data = axyridis_raw, aes(x = decimalLongitude, y = decimalLatitude),
        colour = "darkgreen", alpha = 0.7
    ) +
    geom_point(
        data = axyridis_clean, aes(x = Lon, y = Lat),
        colour = "blue", alpha = 0.7
    )
ggsave(m_glob, filename = "R/plots/gbif_raw_vs_clean_global.png")
```

```{r, plot lc with map}
countries <- ne_countries(scale = "medium", type = "countries", returnclass = "sf")
countries <- st_transform(countries, crs = crs(lc_16_eu))
m_lc <- ggplot(countries) +
    geom_raster(lc_16_eu, aes(fill = lccs_class, alpha = 0.5))
ggsave(m_lc, filename = "R/data/plotting/lc_glob_extents.pdf")
```

```{r, how many raw occs before 2002 eu and as}
#create uncleaned eu and as subsets (modified copy of occ_clean)
# load raw gbif data
axyridis_raw <- read.csv("R/data/occurence_data/Harmonia-axyridis_gbif_raw.csv",
    header = TRUE,
    sep = "\t"
)

# only take relevant columns
axyridis_raw <- axyridis_raw[c("decimalLatitude", "decimalLongitude", "year", "coordinateUncertaintyInMeters")]
names(axyridis_raw) <- c("Lat", "Lon", "Year", "CoordUncert")

# remove relevant NAs in data
# remove occurences after 2022
axyridis_sub <- subset(axyridis_raw, !is.na(Lat & Lon & Year & CoordUncert))

# subset data into eu and as spatial extent 
# land cover layers vor reference (xmin, xmax, ymin, ymax)
eu <- ext(rast("R/data/cropped_rasters/Cop_LC_2016_eu.grd"))
as <- ext(rast("R/data/cropped_rasters/Cop_LC_2016_as.grd"))
# some issue with crop and SpatVector with terra, so ugly subset
axyridis_eu <- subset(axyridis_sub, Lon > eu[1] & Lon < eu[2] & Lat > eu[3] & Lat < eu[4])
axyridis_as <- subset(axyridis_sub, Lon > as[1] & Lon < as[2] & Lat > as[3] & Lat < as[4])

eu_bef2k = count(subset(axyridis_eu, Year < 2002))[[1]]
as_bef2k = count(subset(axyridis_as, Year < 2002))[[1]]
print(paste('Raw EU < 2002:', eu_bef2k, "Raw Native < 2002:", as_bef2k))
```

```{r, plot yearly occ frequency 2002-2022 with cleaned occs}
occs <- readRDS("R/data/occurence_data/axyridis_clean.rds")
occs_eu <- subset(occs, Area == "EU" & Year >= 2002)
occs_as <- subset(occs, Area == "AS" & Year >= 2002)

# get occurences per year as df
freq_eu <- count(occs_eu, Year) # frequency of yearly occs eu
freq_as <- count(occs_as, Year) # frequency of yearly occs as
freqs <- data.frame(Year = 2002:2022, n = 0)
freqs[match(freq_eu$Year, freqs$Year), ] <- freq_eu # add missing years
freqs_tot <- data.frame(Year = freqs$Year, n_eu = freqs$n)
freqs <- data.frame(Year = 2002:2022, n = 0)
freqs[match(freq_as$Year, freqs$Year), ] <- freq_as # add missing years
freqs_tot$n_as <- freqs$n
freqs_tot$n_tot <- freqs_tot$n_eu + freqs_tot$n_as
#reformat df to long format for ggplot
l = length(freqs$Year)
frequencies <- data.frame(
    Year = c(freqs_tot$Year, freqs_tot$Year, freqs_tot$Year),
    n = c(freqs_tot$n_as, freqs_tot$n_eu, freqs_tot$n_tot),
    label = c(rep("Native", l), rep("EU", l), rep("Total", l))
)

# find out how many occurences are before 2000
eu_bef2k = count(subset(occs, Area == "EU" & Year < 2002))[[1]]
as_bef2k = count(subset(occs, Area == "AS" & Year < 2002))[[1]]
cap = paste('Cleaned EU < 2002:', eu_bef2k, "Cleaned Native < 2002:", as_bef2k)
plot <- ggplot(frequencies, aes(x = Year, y = n)) +
    geom_point(alpha = 0.5, aes(colour = label)) +
    labs(title = 'cleaned yearly occurrences', caption = cap)
plot
ggsave(plot, filename = "R/plots/clean_occ_yearly_tot_eu_as.png")
logplot <- plot + scale_y_continuous(trans = "log10")
logplot
ggsave(logplot, filename = "R/plots/clean_occ_yearly_tot_eu_as_log.png")
print(cap)
```

```{r, test absence distance flagging}
test = buffer(vect(rbind(c(0,0), c(1,1)), crs = '+proj=longlat'), 10000)[1]
set.seed(54)
t_pres = spatSample(circs, 5)
gen = spatSample(test, 100)
set.seed(168)
flag = gen[apply(distance(gen, t_pres),1, function(x) any(x < 2000)), ]
plot(circs)
points(t_pres, col = 'green')
points(gen, col = 'grey')
points(flag, col = 'red')
```